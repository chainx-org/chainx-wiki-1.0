# ChainX 智能合约

## 运行节点

### 1. 接入测试网

 请参考[加入ChainX测试网](Join-ChainX-Testnet)的相关说明。

完成相关配置后，应保证节点同步到最新，钱包相应配置完成。

### 2. 运行本地节点

请参考[ChainX Dev模式](ChainX-Dev)的相关说明。

完成相应配置后，请保证已经出块超过150个区块，因为150个块后才会对Alice发放第一层次奖励。

若需要反复测试，可以对超过150个块后的区块数据进行备份，若需重新启动，则只需要删除老数据目录，使用备份数据目录替换即可。

## ChainX上的Substrate Contracts 智能合约平台

// TODO

## ChainX智能合约中的跨链资产

**当前ChainX智能合约中只支持比特币**

### ChainX 智能合约中多币种的实现方式

由于Substrate Contracts智能合约平台模型与以太坊智能合约模型相似，对于多币种的处理是“本币+代币”模型。

针对这种模型，ChainX的智能合约上的跨链资产采用合约代币模型，因此在ChainX上PCX将会类似以太坊一样对智能合约提供gas及本币流通的价值，对于ChainX上的跨链资产以合约代币的形式引入。

使用代币模型而不是将多币种直接引入合约基于如下考虑：

1. 以太坊代币合约已经比较成熟，因此对于合约开发者在代币模型下可以比较容易的将以太坊合约迁移到ChainX智能合约平台上。
2. 若在合约中引入多币种的概念，将会极大修改Substrate Contracts的模型，容易引入非预期问题。

**当前ChainX实现智能合约中的比特币采用XRC20模型**，根据合约开发者的反馈，将来也可采用其他标准。目前已经考虑的代币模型有：

1. XRC20(原以太坊ERC20)
2. XRC721(原以太坊ERC721)
3. XRC777(原以太坊ERC777)

### ChainX资产中的多币种与合约中代币的转换

#### ChainX上的比特币X-BTC

当前X-BTC对应于智能合约平台中采用的代币模型为XRC20。**用户可以自由发起交易让ChainX的X-BTC与合约平台中的XRC20互相转换。**

![xrc20模型](https://user-images.githubusercontent.com/5023721/68760304-7e08ab80-064c-11ea-9c00-28677d41e5d0.png)

其中ChainX修改了ERC20合约标准（XRC20），添加了`issue`，`destroy`两个接口。并**首先将一个合约部署到链上并实例化，同时在链上唯一指定了这个合约实例，因此除指定的实例以外的代币实例均不被ChainX的Runtime承认**

其中：

* `issue` 只能被Runtime中的交易`convert_to_xrc20`调用，不可通过直接调用合约方法调用。通过交易`convert_to_xrc20`调用后，将会把该用户的资产转移到合约实例下，并在合约中对该发送交易的账户自动发放相应的金额。
* `destroy` 能被用户调用，用于将合约中的资产转移到ChainX资产模块中。其中首先销毁了合约中对应的代币，然后**合约中会自动调用**`convert_to_assets`将资产从合约中返回给用户，而`convert_to_assets`不可通过外部交易调用。

#### ChainX上的XRC20

部署于ChainX上的XRC20项目为：

[https://github.com/chainx-org/xrc20](https://github.com/chainx-org/xrc20)

针对XRC20，ChainX已经提供了2个对应的RPC可进行操作：

* [chainx_contractXRCTokenInfo](RPC#chainx_contractXRCTokenInfo)
* [chainx_contractXRC20Call](RPC#chainx_contractXRC20Call)

#### 主网与测试网-道

对于主网与测试网-道，该针对X-BTC的合约实例已经部署且被设置完成。合约开发者或用户只需要在合约平台上导入该项目中的abi 文件`target/abi.json`即可调用合约。其中该XRC20的地址可以通过rpc `chainx_contractXRCTokenInfo` 获取到。

#### ChainX Dev 节点

对于ChainX Dev 节点而言，该合约没有被内置。因此若需要调试和智能合约上的比特币相关操作，需要：

1. 在ChainX Dev 中设置XRC20-BTC 合约
2. 发放测试使用的假X-BTC

在`xrc20`项目中已经提供了一个脚本执行这两件事情，详情请参考README。

该脚本默认使用Alice的私钥（见[ChainX Dev模式](ChainX-Dev)的开头部分）执行。请注意执行该脚本至少需要等待已经出了150个区块后（Alice才会具备资产执行交易）。

## ChainX 智能合约的部署即测试

智能合约的部署及调用请参考ChainX钱包部分。

测试请参考[ChainX Dev模式|调试合约](ChainX-Dev#调试合约)部分







